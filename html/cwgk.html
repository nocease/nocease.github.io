<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
		<title>自动村务公开访问V1.3</title>
	</head>
	<script>
		var access_token = ""; //用户登录后的access_token
		var deptId = "";
		var url = "";
	</script>
	<body>
		<h2>自动村务公开访问V1.3</h2>
		<h3>作者：<a href="https://github.com/nocease" target="_blank">不停止nocease</a> </h3>
		<h3>本页面仅供学习交流，不得用于非法用途</h3>
		<h3>本页面使用的前端技术有 jQuery、Ajax</h3>
		<hr>
		<h3>第一步：</h3>
		<input id="user1" type="text" value="" placeholder="输入账号:">
		<input id="pass1" type="text" value="cwgk@202209" placeholder="输入密码:">
		<button onclick="dotest()">检测</button>&nbsp;（输入你们村任意一个人的账号，点击检测）
		<p id="p1"></p>
		<script>
			function dotest() {
				let user1 = $("#user1").val()
				let pass1 = $("#pass1").val()
				$("#p1").text("")
				$.ajax({
					//dataType: 'json',
					url: "https://cwgk.hbree.cn/auth/wechatLogin",
					dataType: "JSON",
					async: false,
					type: "POST",
					contentType: "application/json",
					data: JSON.stringify({
						"username": user1,
						"password": pass1
					}),
					success: function(data) {
						if (data.code == 200) {
							access_token = data.data.access_token;
							//$("#log").prepend("尝试模拟登录：手机号" + user1 + "，密码" + pass1 + "<br>登录成功! ")
						} else {
							//$("#log").prepend("尝试模拟登录：手机号" + user1 + "，密码" + pass1 + "<br>账号或密码错误！<hr>")
							access_token = "";
						}
					},
				})
				$.ajax({
					url: "https://cwgk.hbree.cn/system/user/getUserInfo",
					async: false,
					type: "get",
					headers: {
						"Authorization": access_token,
						'Content-Type': 'application/json'
					},
					success: function(data) {
						if (data.code == 200) {
							$("#p1").append("当前账号姓名：" + data.data.nickName + "，");
							$.ajax({
								url: "https://cwgk.hbree.cn/system/dept/getdeptName?deptId=" + data.data
									.deptId,
								async: false,
								type: "get",
								headers: {
									"Authorization": access_token,
									'Content-Type': 'application/json'
								},
								success: function(data) {
									deptId = data.data.deptId;
									url = data.data.url;
									let ctime = url.substring(url.length - 13);
									$("#p1").append("当前账号所属村：" + data.data.deptName + "<br>")
									$("#p1").append("已获取当前村用于验证扫码的加密时间戳：" + ctime + "<br>")
									$("#p1").append("已获取当前村的deptId：" + deptId + "<br>")
									$("#log").prepend("<hr>已登录成功并抓取了关键数据。")
									document.getElementById("tap2").style.display = "";
								},
							})
						} else {
							$("#p1").prepend("账号或密码错误。<hr>");
						}
					},
				})
			}
		</script>

		<div id="tap2" style="display:none">
			<h3>第二步：</h3>
			<textarea placeholder='输入JSON格式的所有账户和密码:' id='users' style='width: 500px;height: 70px'></textarea>
			<br>输入你们村所有人的账号和密码，格式为：<br>
			[{"user": "15713190000", "password": "cwgk@202209" },{ "user": "15713190001", "password":
			"cwgk@202209"}]
			<br>可以使用 <a href="https://tableconvert.com/zh-cn/excel-to-json" target="_blank">Excel转Json工具</a><br>
			<br> <button onclick="ok()">开始模拟登录浏览</button>
			<button onclick="wccode()">开始模拟扫码登录（测试版）</button>
		</div>
		<hr style="height:5px;border:none;color:#333;background-color:#333;" />
		<h3>日志：</h3>
		<div id="log"></div>
	</body>
	<script>
		//点击开始
		async function ok() {
			if (document.getElementById("users").value != "") {
				var users = JSON.parse(document.getElementById("users").value)
				for (let i = 0; i < users.length; i++) {
					await wechatLogin(users[i].user, users[i].password)
				}
			}
		}

		async function wechatLogin(user1, pass1) {
			try {
				// 第一个Ajax请求
				const response1 = await $.ajax({
					url: "https://cwgk.hbree.cn/auth/wechatLogin",
					dataType: "JSON",
					type: "POST",
					contentType: "application/json",
					data: JSON.stringify({
						"username": user1,
						"password": pass1
					})
				});

				if (response1.code == 200) {
					access_token = response1.data.access_token;
					$("#log").prepend("尝试模拟登录：手机号" + user1 + "，密码" + pass1 + "，登录成功!");
					$("#log").prepend("<br>");
				} else {
					$("#log").prepend("尝试模拟登录：手机号" + user1 + "，密码" + pass1 + "，账号或密码错误！<hr>");
					access_token = "";
				}

				// 第一个请求完成后执行第二个请求
				const response2 = await $.ajax({
					url: "https://cwgk.hbree.cn/system/user/getUserInfo",
					type: "get",
					headers: {
						"Authorization": access_token,
						'Content-Type': 'application/json'
					}
				});

				$("#log").prepend("当前账号姓名：" + response2.data.nickName);
				$("#log").prepend("<br>");


				const response3 = await $.ajax({
					url: "https://cwgk.hbree.cn/system/dept/getdeptName?deptId=" + response2.data.deptId,
					type: "get",
					headers: {
						"Authorization": access_token,
						'Content-Type': 'application/json'
					}
				});
				$("#log").prepend("当前账号所属村：" + response3.data.deptName);
				$("#log").prepend("<br>");

				// 第二个请求完成后的处理
				const response4 = await $.ajax({
					url: "https://cwgk.hbree.cn/system/document/list?smallCategory=112&keyString=&deptId=" +
						response2.data.deptId,
					type: "get",
					headers: {
						"Authorization": access_token,
						'Content-Type': 'application/json'
					}
				});

				$("#log").prepend("模拟加载党务公开列表：发现" + response4.total + "条。");
				$("#log").prepend("<br>");
				$("#log").prepend("最上面一条是：" + response4.rows[0].title);
				$("#log").prepend("<br>");
				$("#log").prepend("尝试访问：" + response4.rows[0].title);

				const response5 = await $.ajax({
					url: "https://cwgk.hbree.cn/system/document/getAffairDetail?documentId=" + response4.rows[0]
						.documentId,
					type: "get",
					headers: {
						"Authorization": access_token,
						'Content-Type': 'application/json'
					}
				});
				$("#log").prepend("<br>");
				$("#log").prepend(response5.msg);
				$("#log").prepend("<hr>");
			} catch (error) {
				//$("#log").prepend("<hr>发生一个错误：" + JSON.stringify(error) + "<hr>");
			}
		}
	</script>

	<script>
		//模拟扫码登录（测试版）
		async function wccode() {
			for (let i = 0; i < 100; i++) {
				await new Promise(resolve => {
					$.ajax({
						url: "https://cwgk.hbree.cn/system/dept/getQRcodeState",
						dataType: "JSON",
						type: "POST",
						headers: {
							"Content-Type": "application/json",
							"Rederer": "https://servicewechat.com/wx6f7f3cf4005f4209/34/page-frame.html"
						},
						data: JSON.stringify({
							"url": url
						}),
						success: function(data) {
							$("#log").prepend(i + "次模拟扫码成功<br>");
							resolve(); // 请求成功后调用 resolve()，表示当前请求已完成
						},
					});
				});
			}
		}
	</script>
</html>
